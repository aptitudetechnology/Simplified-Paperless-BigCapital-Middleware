<!-- templates/documents.html -->
{% extends "base.html" %}

{% block title %}Documents – {{ super() }}{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
  <h1 class="h2">Documents</h1>
  <div class="btn-toolbar mb-2 mb-md-0">
    <div class="btn-group me-2">
      <a href="{{ url_for('web.upload_page') }}" class="btn btn-sm btn-primary" aria-label="Upload Document">
        <i class="fas fa-plus"></i> Upload
      </a>
      <button type="button" class="btn btn-sm btn-outline-secondary" onclick="location.reload()" aria-label="Refresh Page">
        <i class="fas fa-sync-alt"></i> Refresh
      </button>
    </div>
  </div>
</div>

<div class="main-content">
  <!-- Filters -->
  <form class="row g-3 mb-4" id="filterForm">
    <div class="col-md-3">
      <label for="statusFilter" class="form-label">Status</label>
      <select class="form-select" id="statusFilter" name="status">
        <option value="">All Statuses</option>
        <option value="uploaded">Uploaded</option>
        <option value="processing">Processing</option>
        <option value="processed">Processed</option>
        <option value="error">Error</option>
      </select>
    </div>
    <div class="col-md-3">
      <label for="typeFilter" class="form-label">Type</label>
      <select class="form-select" id="typeFilter" name="doc_type">
        <option value="">All Types</option>
        <option value="invoice">Invoice</option>
        <option value="receipt">Receipt</option>
        <option value="other">Other</option>
      </select>
    </div>
    <div class="col-md-3">
      <label for="dateFilter" class="form-label">Date Range</label>
      <select class="form-select" id="dateFilter" name="date_range">
        <option value="">All Dates</option>
        <option value="today">Today</option>
        <option value="week">This Week</option>
        <option value="month">This Month</option>
        <option value="custom">Custom Range</option>
      </select>
    </div>
    <div class="col-md-3">
      <label for="searchFilter" class="form-label">Search</label>
      <div class="input-group">
        <input type="text" class="form-control" id="searchFilter" name="search" placeholder="Search documents…" />
        <button class="btn btn-outline-secondary" type="submit" aria-label="Search">
          <i class="fas fa-search"></i>
        </button>
      </div>
    </div>
  </form>

  <!-- Custom Date Range (hidden by default) -->
  <div class="row mb-3" id="customDateRange" style="display:none;">
    <div class="col-md-3">
      <label for="startDate" class="form-label">Start Date</label>
      <input type="date" class="form-control" id="startDate" name="start_date" />
    </div>
    <div class="col-md-3">
      <label for="endDate" class="form-label">End Date</label>
      <input type="date" class="form-control" id="endDate" name="end_date" />
    </div>
  </div>

  <!-- Documents Table -->
  <div class="table-responsive">
    <table class="table table-striped table-hover">
      <thead>
        <tr>
          <th><input type="checkbox" id="selectAll" class="form-check-input" /></th>
          <th>Filename</th>
          <th>Status</th>
          <th>Type</th>
          <th>Upload Date</th>
          <th>Size</th>
          <th>Confidence</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="documentsTable">
        <tr>
          <td colspan="8" class="text-center py-4">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Loading…</span>
            </div>
            <p class="mt-2 text-muted">Loading documents…</p>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Pagination Controls -->
  <nav aria-label="Documents pagination">
    <ul class="pagination justify-content-center" id="pagination"></ul>
  </nav>

  <!-- Bulk Actions Display -->
  <div class="mt-3" id="bulkActions" style="display:none;">
    <div class="alert alert-info d-flex align-items-center">
      <strong id="selectedCount">0</strong> documents selected
      <div class="btn-group ms-3" role="group" aria-label="Bulk actions">
        <button class="btn btn-sm btn-outline-primary" onclick="bulkProcess()" aria-label="Bulk Reprocess">
          <i class="fas fa-cog"></i> Reprocess
        </button>
        <button class="btn btn-sm btn-outline-warning" onclick="bulkExport()" aria-label="Bulk Export">
          <i class="fas fa-download"></i> Export
        </button>
        <button class="btn btn-sm btn-outline-danger" onclick="bulkDelete()" aria-label="Bulk Delete">
          <i class="fas fa-trash"></i> Delete
        </button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  let currentPage = 1;
  const selectedDocuments = new Set();

  document.addEventListener('DOMContentLoaded', () => {
    loadDocuments();

    document.getElementById('filterForm').addEventListener('submit', debounce(e => {
      e.preventDefault();
      currentPage = 1;
      loadDocuments();
    }, 300));

    document.getElementById('dateFilter').addEventListener('change', e => {
      document.getElementById('customDateRange').style.display =
        e.target.value === 'custom' ? 'block' : 'none';
    });

    document.getElementById('selectAll').addEventListener('change', e => {
      document.querySelectorAll('input[name="documentSelect"]').forEach(cb => {
        cb.checked = e.target.checked;
        if (e.target.checked) selectedDocuments.add(cb.value);
        else selectedDocuments.delete(cb.value);
      });
      updateBulkActions();
    });
  });

  function debounce(fn, ms) {
    let timer;
    return (...args) => {
      clearTimeout(timer);
      timer = setTimeout(() => fn(...args), ms);
    };
  }

  async function loadDocuments() {
    const formData = new FormData(document.getElementById('filterForm'));
    const params = new URLSearchParams([...formData.entries()].filter(([, v]) => v));
    params.append('page', currentPage);
    params.append('per_page', 20);

    try {
      const res = await fetch(`/api/documents?${params}`);
      const data = await res.json();
      if (!data.success) throw new Error(data.error);
      renderDocuments(data.documents);
      renderPagination(data.pagination);
    } catch (e) {
      showAlert('danger', `Error loading documents: ${e.message}`);
    }
  }

  function renderDocuments(docs) {
    const tbody = document.getElementById('documentsTable');

    if (!Array.isArray(docs) || docs.length === 0) {
      tbody.innerHTML = `
        <tr><td colspan="8" class="text-center py-4">
          <i class="fas fa-folder-open fa-3x text-muted mb-3"></i>
          <p class="text-muted">No documents found</p>
          <a href="{{ url_for('web.upload_page') }}" class="btn btn-primary">
            <i class="fas fa-plus"></i> Upload First Document
          </a>
        </td></tr>`;
      return;
    }

    tbody.innerHTML = docs.map(doc => {
      const safeDate = new Date(doc.upload_date || Date.now());
      const size = formatFileSize(doc.file_size || 0);
      const score = doc.confidence_score;
      return `
      <tr class="${doc.status === 'error' ? 'table-danger' : ''}">
        <td>
          <input type="checkbox" name="documentSelect" value="${doc.id}" class="form-check-input"
            onchange="toggleSelection('${doc.id}', this.checked)">
        </td>
        <td>
          <div class="d-flex align-items-center">
            <i class="fas ${getFileIcon(doc.filename || '')} me-2"></i>
            <div>
              <div class="fw-bold">${doc.filename || 'Unnamed'}</div>
              ${(doc.original_filename && doc.original_filename !== doc.filename)
                ? `<small class="text-muted">Original: ${doc.original_filename}</small>` : ''}
            </div>
          </div>
        </td>
        <td>
          <span class="badge ${getStatusBadgeClass(doc.status)}">
            ${(doc.status || 'unknown').charAt(0).toUpperCase() +
              (doc.status || '').slice(1)}
          </span>
        </td>
        <td><span class="badge bg-secondary">${doc.document_type || 'Unknown'}</span></td>
        <td>
          <div>${safeDate.toLocaleDateString()}</div>
          <small class="text-muted">${safeDate.toLocaleTimeString()}</small>
        </td>
        <td>${size}</td>
        <td>${score != null
          ? `<div class="progress" style="width:60px;height:20px">
               <div class="progress-bar ${getConfidenceColor(score)}"
                    style="width:${score}%"
                    title="${score}%"></div></div>`
          : `<span class="text-muted">N/A</span>`}
        </td>
        <td>
          <div class="btn-group" role="group" aria-label="Row actions">
            <a href="{{ url_for('web.view_document', doc_id=0) }}"
               class="btn btn-sm btn-outline-primary" title="View" aria-label="View Document ${doc.filename}">
              <i class="fas fa-eye"></i>
            </a>
            <button class="btn btn-sm btn-outline-secondary" onclick="processDocument('${doc.id}')"
              title="Reprocess" aria-label="Reprocess Document">
              <i class="fas fa-cog"></i>
            </button>
            <a href="/api/documents/${doc.id}/download"
               class="btn btn-sm btn-outline-success" title="Download" aria-label="Download Document">
              <i class="fas fa-download"></i>
            </a>
            <button class="btn btn-sm btn-outline-danger" onclick="deleteDocument('${doc.id}')"
              title="Delete" aria-label="Delete Document">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        </td>
      </tr>`;
    }).join('');
  }

  function renderPagination(pag) {
    const el = document.getElementById('pagination');
    if (!pag.pages || pag.pages <= 1) return el.innerHTML = '';

    let html = `
      <li class="page-item ${pag.current_page == 1 ? 'disabled' : ''}">
        <a class="page-link" href="#" onclick="changePage(${pag.current_page - 1})">Previous</a>
      </li>`;
    for (let i = 1; i <= pag.pages; i++) {
      if (
        i === 1 ||
        i === pag.pages ||
        (i >= pag.current_page - 2 && i <= pag.current_page + 2)
      ) {
        html += `<li class="page-item ${i === pag.current_page ? 'active' : ''}">
          <a class="page-link" href="#" onclick="changePage(${i})">${i}</a>
        </li>`;
      } else if (i === pag.current_page - 3 || i === pag.current_page + 3) {
        html += `<li class="page-item disabled"><span class="page-link">…</span></li>`;
      }
    }
    html += `
      <li class="page-item ${pag.current_page == pag.pages ? 'disabled' : ''}">
        <a class="page-link" href="#" onclick="changePage(${pag.current_page + 1})">Next</a>
      </li>`;
    el.innerHTML = html;
  }

  function changePage(p) {
    currentPage = p;
    loadDocuments();
  }

  function toggleSelection(id, isChecked) {
    if (isChecked) selectedDocuments.add(id);
    else selectedDocuments.delete(id);
    document.getElementById('selectAll').checked =
      document.querySelectorAll('input[name="documentSelect"]:checked').length > 0;
    updateBulkActions();
  }

  function updateBulkActions() {
    const bc = document.getElementById('bulkActions');
    document.getElementById('selectedCount').textContent = selectedDocuments.size;
    bc.style.display = selectedDocuments.size ? 'block' : 'none';
  }

  async function processDocument(id) {
    if (!confirm('Reprocess this document?')) return;
    try {
      const res = await fetch(`/api/documents/${id}/process`, { method: 'POST' });
      const data = await res.json();
      if (!data.success) throw new Error(data.error);
      loadDocuments();
      showAlert('success', 'Processing started successfully');
    } catch (e) {
      showAlert('danger', `Error: ${e.message}`);
    }
  }

  async function deleteDocument(id) {
    if (!confirm('Delete this document?')) return;
    try {
      const res = await fetch(`/api/documents/${id}`, { method: 'DELETE' });
      const data = await res.json();
      if (!data.success) throw new Error(data.error);
      loadDocuments();
      showAlert('success', 'Document deleted');
    } catch (e) {
      showAlert('danger', `Error: ${e.message}`);
    }
  }

  function bulkProcess() {
    if (!selectedDocuments.size || !confirm(
      `Reprocess ${selectedDocuments.size} selected?`
    )) return;
    selectedDocuments.forEach(id => processDocument(id));
    selectedDocuments.clear();
    updateBulkActions();
  }

  function bulkExport() {
    if (selectedDocuments.size)
      window.open(`/api/documents/export?ids=${[...selectedDocuments].join(',')}`, '_blank');
  }

  function bulkDelete() {
    if (!selectedDocuments.size || !confirm(
      `Delete ${selectedDocuments.size} selected?`
    )) return;
    selectedDocuments.forEach(id => deleteDocument(id));
    selectedDocuments.clear();
    updateBulkActions();
  }

  // Utility functions...
  function getFileIcon(fn) { /* unchanged */ }
  function getStatusBadgeClass(s) { /* unchanged */ }
  function getConfidenceColor(n) { /* unchanged */ }
  function formatFileSize(b) { /* unchanged */ }

  function showAlert(type, msg) {
    const alert = document.createElement('div');
    alert.className = `alert alert-${type} alert-dismissible position-fixed top-0 end-0 m-3`;
    alert.setAttribute('role', 'alert');
    alert.innerHTML = `
      ${msg}
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>`;
    document.body.append(alert);
    setTimeout(() => alert.remove(), 4000);
  }
</script>
{% endblock %}
